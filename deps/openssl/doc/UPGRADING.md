## How to upgrade openssl library in io.js

This document is intended to describe the procedure to upgrade openssl
from 1.0.1m to 1.0.2a in io.js.


### Build System and Upgrading Overview
The openssl build system is based on the perl script of Configure.
For example, running `Configure linux_x86-64` in the openssl
repository generates Makefile for linux_x86_64. `Configure TABLE`
shows various build parameters that depend on each os and arch.

In io.js, build target is defined as `--dest-os` and `--dest-cpu` in
configure options which are different from the one that is defined in
openssl.

Here is a table of mapping of each dest-os and dest-cpu in gyp
to the config targets in openssl for use of C and assembler sources
and defines during build.

|   | ia32 | x64 | arm | arm64 | others |
|---|------|-----|-----|-------|--------|
| win | VC-WIN32 | VC-WIN64A | - | - | - |
| mac | darwin-i386-cc|darwin64-x86_64-cc | - | - | - |
| linux and others | linux-elf | linux-x86_64 | linux_armv4 | linux-aarch64 | linux-elf + no-asm |

All parameters such as sources, defines, cflags and others generated
in openssl Makefile are wrote down into `deps/openssl/openssl.gypi`.

The header file of `deps/openssl/openssl/crypto/opensslconf.h` are
generated by `Configure` and varies on each os and arch so that we
made a new `deps/openssl/config/opensslconf.h`, where it includes each
conf file from `deps/openssl/config/archs/*/opensslconf.h` by using
pre-defined compiler macros.

Assembler support is one of the key features in openssl, but asm files
are dynamically generated with
`deps/openssl/openssl/crypto/*/asm/*.pl` by perl during
build. Furthermore, these perl scripts check the version of asm
compiler and generate asm files according to the supported
instructions in each compiler.

Since perl is not a build requirement in iojs, they all should be
generated in advance and statically stored in the repository. We
provide two sets of asm files, one is asm_latest(avx2 and addx
supported) in `deps/openssl/asm` and the other asm_obsolete(without
avx1/2 and addx) in `deps/openssl/asm_obsolute`.

`configure` and gyp check the version of asm compilers such as gnu
as(gas), llvm and Visual Studio. `deps/openssl/openssl.gypi`
determines what asm files should be used, in which the asm_latest
needs the version of gas >= 2.23, llvm >= 3.3 or MSVS_VERSION>='2012'
(ml64 >= 12) as defined in
https://github.com/openssl/openssl/blob/OpenSSL_1_0_2-stable/crypto/sha/asm/sha512-x86_64.pl#L112-L129,
otherwise asm_obsolete are used.

The following is the detail instruction steps how to upgrade openssl
version from 1.0.1m to 1.0.2a in iojs.

### 1. Replace openssl source in `deps/openssl/openssl`
Remove old openssl sources in `deps/openssl/openssl` .
Get original openssl sources from
https://www.openssl.org/source/openssl-1.0.2a.tar.gz and extract all
files into `deps/openssl/openssl` .

### 2. Apply private patches
There are three kinds of private patches to be applied in openssl-1.0.2a.

- The fix of assembly error on ia32 win32. masm is no longer supported
  in openssl. We should move to use nasm or yasm in future version of
  iojs.

- The fix of openssl-cli built on win. Key press requirement of
  openssl-cli in win causes timeout failures of several tests.

- Backport patches for alt cert feature from openssl-1.1.x. Root certs
  of 1024bit RSA key length were deprecated in io.js. When a tls
  server has a cross root cert, io.js client leads CERT_UNTRUSTED
  error because openssl does not find alternate cert chains. This fix
  supports its feature but was made the current master which is
  openssl-1.1.x. We backported them privately into openssl-1.0.2 on
  iojs.

### 3. Replace openssl header files in `deps/openssl/openssl/include/openssl`
all header files in `deps/openssl/openssl/include/openssl/*.h` are
symbolic links in the distributed release tar.gz. They cause issues in
Windows. They are replaced into the files to include a real header
file such as
````
#include "../../crypto/aes/aes.h"
````
### 4. Change `opensslconf.h` so as to fit each platform.
The opensslconf.h in each target was created in advance by typing
`deps/openssl/openssl/Configure {target}` and copied
into `deps/openssl/conf/archs/{target}/opensslconf.h`.
`deps/openssl/conf/openssconf.h` includes each file according to its
target by checking pre-defined compiler macros.

We should remove OPENSSL_CPUID_OBJ define in opensslconf.h because it
causes build error when --openss-no-asm option is specified. Instead,
the OPENSSL_CPUID_OBJ is defined in `deps/openssl/openssl.gypi`
according to the configure options.

### 5. Update openssl.gyp and openssl.gypi
Sources, cflags and define parameters of each target can be obtained
via `Configure TABLE`. Put them into the table list of
[define and cflags changes in openssl-1.0.2a](openssl_define_list.pdf)

### 6. ASM files for openssl
We provide two sets of asm files. One is for the latest asm compiler and the other is the older one.
### 6.1. asm files for the latest compiler
This was made in `deps/openssl/asm/Makefile`
- Updated asm files for each platforms which are required in
  openssl-1.0.2a.
- Some perl files need CC and ASM envs. Added a check if these envs
  exist. Followed asm files are to be generated with CC=gcc and
  ASM=nasm on Linux. See
  `deps/openssl/openssl/crypto/sha/asm/sha512-x86_64.pl`
- Added new 32bit targets/rules with a sse2 flag (OPENSSL_IA32_SSE2)
  to generate asm for use SSE2.
- Generating sha512 asm files in x86_64 need output filename which
  has 512. Added new rules so as not to use stdout for outputs.
- PERLASM_SCHEME of linux-armv4 is `void` as defined in openssl
  Configure. Changed its target/rule and all directories are moved
  from arm-elf-gas to arm-void-gas.
- add a new rule for armv8 asm generation

With export environments of CC=gcc and ASM=nasm, then type make
command and check if new asm files are generated.

### 6.2.asm files for the older compiler
For older asm compiler, the version check of CC and ASM should be
skipped in generating asm file with perl scripts.
Copy files from `deps/openssl/asm` into
`deps/openssl/asm/asm_obsolete` and change rules to generate asm files
into this directories and remove the check of CC and ASM envs.

Without environments of CC and ASM, then type make command and check
if new asm files for older compilers are generated.

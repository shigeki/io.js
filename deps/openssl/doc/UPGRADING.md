## How to upgrade openssl library in io.js

This document is intended to describe the procedure to upgrade openssl from 1.0.1m to 1.0.2a in io.js.

### Build System and Upgrading Overview
The openssl build system is based on the perl script of Configure.
For example, running `Configure linux_x86-64` in the openssl repository generates Makefile for linux_x86_64.
`Configure TABLE` shows various build parameters that depend on each os and arch.

In io.js, build target is defined as `--dest-os` and `--dest-cpu` in configure options which are different from the one that is defined in openssl. Here is a table of mapping each dest-os and dest-cpu in gyp to the config targets in openssl.

|   | ia32 | x64 | arm | arm64 | others |
|---|------|-----|-----|-------|--------|
| win | VC-WIN32 | VC-WIN64A | - | - | - |
| mac | darwin-i386-cc|darwin64-x86_64-cc | - | - | - |
| linux and others | linux-elf | linux-x86_64 | linux_armv4 | linux-aarch64 | linux-elf + no-asm |

All parameters such as sources, defines, cflags and others generated in openssl Makefile are wrote down into `deps/openssl/openssl.gypi`. The header file of `deps/openssl/openssl/crypto/opensslconf.h` are generated by `Configure` and varies on each os and arch so that we made a new `deps/openssl/config/opensslconf.h` to be referred from `deps/openssl/openssl/crypto/opensslconf.h` for all targets by using ifdef switch.

Assembler support is one of the key features in openssl, but asm files are dynamically generated with `deps/openssl/openssl/crypto/*/asm/*.pl` by perl during build. Furthermore, these perl scripts check the version of asm compiler and generate asm files according to the supported instructions in each compiler.

Since perl is not a build requirement in iojs, they all should be generated in advance and statically stored in the repository. We provide two sets of asm files, one is asm_latest(avx2 and addx supported) in `deps/openssl/asm` and the other asm_obsolete(without avx1/2 and addx) in `deps/openssl/asm_obsolute`.

`configure` and gyp check the version of asm compilers such as gnu as(gas), llvm and Visual Studio. `deps/openssl/openssl.gypi` determines what asm files should be used, in which the asm_latest needs the version of gas >= 2.23, llvm >= 3.3 or MSVS_VERSION>='2012' (ml64 >= 12) as defined in https://github.com/openssl/openssl/blob/OpenSSL_1_0_2-stable/crypto/sha/asm/sha512-x86_64.pl#L112-L129, otherwise asm_obsolete are used.

The following is the detail instruction steps how to upgrade openssl version from 1.0.1m to 1.0.2a in iojs.

### 1. Replace openssl source in `deps/openssl/openssl`
Remove old openssl sources in `deps/openssl/openssl` .
Get original openssl sources from https://www.openssl.org/source/openssl-1.0.2a.tar.gz and extract all files into `deps/openssl/openssl` .

### 2. Apply private patches
There are three kinds of private patches to be applied in openssl-1.0.2a.

- The fix of assembly error on ia32 win32. masm is no longer supported in openssl. We should move to use nasm or yasm in future version of iojs.

- The fix of openssl-cli built on win. Key press requirement of openssl-cli in win causes timeout failures of several tests.

- Backport patches for alt cert feature from openssl-1.1.x. Root certs of 1024bit RSA key length were deprecated in io.js. When a tls server has a cross root cert, io.js client leads CERT_UNTRUSTED error because openssl does not find alternate cert chains. This fix supports its feature but was made the current master which is openssl-1.1.x. We backported them privately into openssl-1.0.2 on iojs.

### 3. Replace openssl header files in `deps/openssl/openssl/include/openssl`
all header files in `deps/openssl/openssl/include/openssl/*.h` are symbolic links in the distributed release tar.gz. They cause issues in Windows. They are replaced into the files to include a real header file such as
````
#include "../../crypto/aes/aes.h"
````
### 4. Change `opensslconf.h` so as to fit each platform.
`deps/openssl/openssl/crypto/opensslconf.h` was generated by `Configure` script in openssl. It varies depending on each platform. We made the first `opensslconf.h` generated with `./Confiure linux-x86_64` as a template file and changed it so as to be listed in [diffs on crypto/opensslconf.h between platforms in openssl-1.0.2a](openssl_conf.pdf).

### 5. Update openssl.gyp and openssl.gypi
Sources, cflags and define parameters of each target can be obtained via `Configure TABLE`. Put them into the table list of [define and cflags changes in openssl-1.0.2a](openssl_define_list.pdf)

### 6. ASM files for openssl
We provide two sets of asm files. One is for the latest asm compiler and the other is the older one.
### 6.1. asm files for the latest compiler
This was made in `deps/openssl/asm/Makefile`
- Updated asm files for each platforms which are required in openssl-1.0.2a. The changes of asm files are checked by comparing files between `openssl-1.0.2a/crypto/*/*.s` and `deps/openssl/asm/x64-elf-gas/*/*.s` in linux-x64 case.
- Some perl files in `deps/openssl/openssl/crypto/*/asm/*.pl` need CC and ASM envs. Added a check if these envs exist. Followed asm files are to be generated with CC=gcc and ASM=nasm on Linux.
- Added new 32bit targets/rules with a sse2 flag (OPENSSL_IA32_SSE2) to generate asm to use SSE2.
- Generating sha512 asm files in x86_64 with `deps/openssl/openssl/crypto/sha/asm/sha512-x86_64.pl` need output file name which has 512 in . Added a new rule and target directory of asm/sha512 to store them.
- PERLASM_SCHEME of linux-armv4 is `void` as defined in openssl Configure. Changed its target/rule and all directories are moved from arm-elf-gas to arm-void-gas.
- add a new rule for armv8 asm generation

With export environments of CC=gcc and ASM=nasm, then type make command and check if new asm files are generated.
### 6.2.asm files for the older compiler
For older asm compiler, the version check of CC and ASM should be skipped in generating asm file with perl scripts.
Copy files from `deps/openssl/asm` into `deps/openssl/asm/asm_obsolete` and change rules to generate asm files into this directories and remove the check of CC and ASM envs.

Without environments of CC and ASM, then type make command and check if new asm files for older compilers are generated.
